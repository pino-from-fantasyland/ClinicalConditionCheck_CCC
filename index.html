<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CCC_臨床コンディションチェック</title>
    
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Tailwind CSS CDN (スタイリング用) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts (Noto Sans JP) -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #f0fdfa; /* calming teal background */
            color: #334155;
        }
        /* ラジオボタンのカスタムスタイル */
        .rating-option input:checked + label {
            background-color: #0d9488; /* teal-600 */
            color: white;
            border-color: #0d9488;
        }
        .rating-option label:hover {
            background-color: #ccfbf1; /* teal-100 */
        }
        /* スムーズスクロール */
        html {
            scroll-behavior: smooth;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-8 px-4">

    <!-- ヘッダー -->
    <header class="w-full max-w-2xl mb-8 text-center">
        <h1 class="text-3xl font-bold text-teal-800 mb-2">臨床コンディションチェック</h1>
        <p class="text-sm text-gray-600">この質問はProQOL-9をベースに作成しています。</p>
        <p class="text-sm text-gray-600">このチェックは非公式であり、正式な診断には使用しないでください。</p>
    </header>

    <!-- メインフォーム -->
    <main class="w-full max-w-2xl bg-white rounded-xl shadow-lg p-6 md:p-8">
        
        <!-- 回答方法セクション -->
        <div class="mb-8 bg-blue-50 p-6 rounded-lg text-blue-900 border-l-4 border-blue-500 shadow-sm">
            <h2 class="font-bold text-xl mb-3 flex items-center">
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                回答方法
            </h2>
            <p class="text-lg leading-relaxed">
                過去30日間のあなたの状態について、最も当てはまるものを直感で選んでください。
            </p>
            <div class="mt-4 flex flex-wrap gap-3 text-sm font-medium text-gray-700 bg-white bg-opacity-60 p-3 rounded">
                <span class="px-2 py-1 bg-white rounded shadow-sm">0 = まったくない</span>
                <span class="px-2 py-1 bg-white rounded shadow-sm">1 = ほとんどない</span>
                <span class="px-2 py-1 bg-white rounded shadow-sm">2 = ときどきある</span>
                <span class="px-2 py-1 bg-white rounded shadow-sm">3 = よくある</span>
                <span class="px-2 py-1 bg-white rounded shadow-sm">4 = ほぼいつもある</span>
            </div>
        </div>

        <form id="checkForm" onsubmit="event.preventDefault(); calculateScore();">
            <div id="questions-container" class="space-y-10">
                <!-- JavaScriptで質問項目をここに生成します -->
            </div>

            <div class="mt-12 flex flex-col gap-4 sm:flex-row justify-center border-t pt-8">
                <button type="button" onclick="resetForm()" class="px-6 py-3 rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-100 transition duration-200 font-medium w-full sm:w-auto">
                    リセット
                </button>
                <button type="submit" class="px-8 py-3 rounded-lg bg-teal-600 text-white hover:bg-teal-700 shadow-md transition duration-200 font-bold text-lg w-full sm:w-auto flex items-center justify-center">
                    <span>結果を見る</span>
                    <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
            </div>
        </form>
    </main>

    <!-- 結果表示セクション (初期状態は非表示) -->
    <section id="result-section" class="w-full max-w-2xl mt-8 hidden">
        <div class="bg-white rounded-xl shadow-lg p-6 md:p-8 border-t-8 border-teal-500">
            <h2 class="text-2xl font-bold text-teal-800 mb-2 text-center">分析結果</h2>
            <p class="text-center font-bold text-teal-600 mb-2 text-lg">
                チャートのエリアが大きいほど<br class="md:hidden">あなたは健康的に働けています
            </p>
            <p class="text-center text-gray-500 mb-6 text-sm">直近の結果と前回の比較</p>
            
            <!-- チャートエリア -->
            <div class="relative w-full h-80 mb-10">
                <canvas id="resultChart"></canvas>
            </div>

            <!-- スコア詳細 -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                
                <!-- CS 共感満足 -->
                <div class="rounded-xl border shadow-sm overflow-hidden flex flex-col h-full bg-white">
                    <div class="bg-green-50 p-3 border-b border-green-100 text-center">
                        <h3 class="font-bold text-green-800">共感満足 (CS)</h3>
                        <p class="text-xs text-green-700 mt-1">高いほど <span class="font-bold">健康</span></p>
                    </div>
                    <div class="p-4 text-center flex-grow flex flex-col justify-center">
                        <div class="text-4xl font-bold text-gray-800 mb-1"><span id="score-cs">0</span><span class="text-lg text-gray-400 font-normal">/12</span></div>
                        <!-- 前回比表示エリア -->
                        <div id="diff-cs" class="h-5 mb-1 flex items-center justify-center"></div>
                        <!-- 判定表示エリア -->
                        <div id="status-cs" class="mt-1 text-sm font-bold px-3 py-1 rounded-full inline-block mx-auto bg-gray-100 text-gray-500">
                            ---
                        </div>
                    </div>
                </div>

                <!-- BO バーンアウト -->
                <div class="rounded-xl border shadow-sm overflow-hidden flex flex-col h-full bg-white">
                    <div class="bg-orange-50 p-3 border-b border-orange-100 text-center">
                        <h3 class="font-bold text-orange-800">バーンアウト (BO)</h3>
                        <p class="text-xs text-orange-700 mt-1">高いほど <span class="font-bold">高負荷</span></p>
                    </div>
                    <div class="p-4 text-center flex-grow flex flex-col justify-center">
                        <div class="text-4xl font-bold text-gray-800 mb-1"><span id="score-bo">0</span><span class="text-lg text-gray-400 font-normal">/12</span></div>
                        <!-- 前回比表示エリア -->
                        <div id="diff-bo" class="h-5 mb-1 flex items-center justify-center"></div>
                        <!-- 判定表示エリア -->
                        <div id="status-bo" class="mt-1 text-sm font-bold px-3 py-1 rounded-full inline-block mx-auto bg-gray-100 text-gray-500">
                            ---
                        </div>
                    </div>
                </div>

                <!-- CF 共感疲労 -->
                <div class="rounded-xl border shadow-sm overflow-hidden flex flex-col h-full bg-white">
                    <div class="bg-red-50 p-3 border-b border-red-100 text-center">
                        <h3 class="font-bold text-red-800">共感疲労 (CF)</h3>
                        <p class="text-xs text-red-700 mt-1">高いほど <span class="font-bold">高負荷</span></p>
                    </div>
                    <div class="p-4 text-center flex-grow flex flex-col justify-center">
                        <div class="text-4xl font-bold text-gray-800 mb-1"><span id="score-cf">0</span><span class="text-lg text-gray-400 font-normal">/12</span></div>
                        <!-- 前回比表示エリア -->
                        <div id="diff-cf" class="h-5 mb-1 flex items-center justify-center"></div>
                        <!-- 判定表示エリア -->
                        <div id="status-cf" class="mt-1 text-sm font-bold px-3 py-1 rounded-full inline-block mx-auto bg-gray-100 text-gray-500">
                            ---
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-gray-50 rounded-lg p-4 text-sm text-gray-600 border border-gray-200 mb-8">
                <h4 class="font-bold mb-2 text-gray-700">結果の見方</h4>
                <ul class="list-disc list-inside space-y-1 ml-2">
                    <li><span class="font-bold text-green-700">共感満足 (CS)</span>：援助することへの喜びです。点数が高いほど精神的に健康な状態です。</li>
                    <li><span class="font-bold text-orange-700">バーンアウト (BO)</span>：仕事に対する無力感や消耗感です。点数が高いほど負荷が高い状態です。</li>
                    <li><span class="font-bold text-red-700">共感疲労 (CF)</span>：他者のトラウマに触れることによるストレスです。点数が高いほど負荷が高い状態です。</li>
                </ul>
            </div>

            <!-- 履歴一覧テーブル -->
            <div class="mt-8 border-t border-gray-200 pt-8">
                <h3 class="text-xl font-bold text-teal-800 mb-4 text-center">過去の診断履歴</h3>
                <p class="text-xs text-gray-500 text-center mb-4">最大10件までの履歴を保存・表示しています。</p>
                
                <div class="overflow-x-auto rounded-lg border border-gray-200">
                    <table class="min-w-full text-sm text-center">
                        <thead class="bg-teal-50 text-teal-800">
                            <tr>
                                <th class="py-3 px-4 border-b font-medium">実施日</th>
                                <th class="py-3 px-4 border-b font-medium">CS</th>
                                <th class="py-3 px-4 border-b font-medium">BO</th>
                                <th class="py-3 px-4 border-b font-medium">CF</th>
                            </tr>
                        </thead>
                        <tbody id="history-tbody" class="bg-white text-gray-700">
                            <!-- JSで生成されます -->
                        </tbody>
                    </table>
                </div>
            </div>
            
        </div>
    </section>

    <footer class="mt-12 text-center text-gray-400 text-xs pb-4">
        &copy; 2024 Clinical Condition Check App
    </footer>

    <script>
        // --- データ定義 ---
        
        // 質問リスト
        const questions = [
            { id: 1, text: "私は治療にあたる人々のトラウマ的なストレスの影響を受けてしまっているかもしれないと思う。", category: 'CF' },
            { id: 2, text: "私の心は援助者としての仕事に縛られていると感じる。", category: 'BO' },
            { id: 3, text: "援助者としての自分の仕事が好きだ。", category: 'CS' },
            { id: 4, text: "私が援助している人々のトラウマ体験のせいで、憂鬱な気分になる。", category: 'CF' },
            { id: 5, text: "自分の仕事に満足感をおぼえる。", category: 'CS' },
            { id: 6, text: "セラピストとして仕事に臨んだ結果、私の心が消耗したように感じる。", category: 'BO' },
            { id: 7, text: "仕事の負担が果てしなく思え、圧倒されていると感じる。", category: 'BO' },
            { id: 8, text: "「患者さんの身に起こった悲劇」が「自分や身内に起こるかも」と不意に考えて怖くなる。", category: 'CF' },
            { id: 9, text: "この仕事をすることを選んで幸せだと思う。", category: 'CS' }
        ];

        // 回答の選択肢
        const options = [
            { value: 0, label: "0" },
            { value: 1, label: "1" },
            { value: 2, label: "2" },
            { value: 3, label: "3" },
            { value: 4, label: "4" }
        ];

        // ストレージキー
        const STORAGE_KEY = 'proqol_history';
        const MAX_HISTORY_COUNT = 10; // 最大保存件数
        
        // チャートインスタンス保持用
        let radarChart = null;

        // --- 初期化処理 ---
        document.addEventListener('DOMContentLoaded', () => {
            renderQuestions();
            // 本番環境用：デモデータの読み込み処理を削除済み
        });

        // --- ビュー描画関数 ---

        // 質問項目のHTML生成
        function renderQuestions() {
            const container = document.getElementById('questions-container');
            container.innerHTML = '';

            questions.forEach((q, index) => {
                const qDiv = document.createElement('div');
                qDiv.className = "border-b border-gray-100 pb-8 last:border-0";
                
                // 質問文
                const title = document.createElement('p');
                title.className = "font-bold text-gray-800 mb-4 text-lg md:text-xl";
                title.textContent = `${index + 1}. ${q.text}`;
                qDiv.appendChild(title);

                // ラジオボタンエリア
                const optionsDiv = document.createElement('div');
                optionsDiv.className = "flex justify-between items-center max-w-lg mx-auto sm:mx-0 gap-2";

                options.forEach(opt => {
                    const wrapper = document.createElement('div');
                    wrapper.className = "rating-option flex-1 text-center";
                    
                    const inputId = `q${q.id}_${opt.value}`;
                    
                    const input = document.createElement('input');
                    input.type = "radio";
                    input.name = `q${q.id}`;
                    input.id = inputId;
                    input.value = opt.value;
                    input.className = "hidden"; // デフォルトのラジオボタンは隠す
                    input.required = true;

                    const label = document.createElement('label');
                    label.htmlFor = inputId;
                    label.className = "block w-full py-3 rounded-md border border-gray-300 cursor-pointer transition-colors duration-200 text-gray-600 font-bold select-none text-lg";
                    label.textContent = opt.label;

                    wrapper.appendChild(input);
                    wrapper.appendChild(label);
                    optionsDiv.appendChild(wrapper);
                });

                qDiv.appendChild(optionsDiv);
                
                // ガイドテキスト
                const guide = document.createElement('div');
                guide.className = "flex justify-between text-xs text-gray-400 mt-2 px-1 max-w-lg mx-auto sm:mx-0";
                guide.innerHTML = "<span>まったくない</span><span>ほぼいつもある</span>";
                qDiv.appendChild(guide);

                // --- 質問8の補足コメント追加 ---
                if (q.id === 8) {
                    const noteDiv = document.createElement('div');
                    noteDiv.className = "mt-4 bg-gray-50 border border-gray-200 rounded p-4 text-sm text-gray-600 max-w-lg mx-auto sm:mx-0";
                    noteDiv.innerHTML = `
                        <p class="font-bold mb-1 text-gray-500 text-xs">※補足説明</p>
                        <p>このテキストは直訳がわかりづらいため改変してます</p>
                        <p>原文は以下の通りです。</p>
                        <p>”As a result of my helping, I have intrusive, frightening thoughts.”</p>
                    `;
                    qDiv.appendChild(noteDiv);
                }

                container.appendChild(qDiv);
            });
        }

        // --- ロジック関数 ---

        // スコア計算と保存
        function calculateScore() {
            // バリデーション
            const formData = new FormData(document.getElementById('checkForm'));
            let scores = { CS: 0, BO: 0, CF: 0 };
            let answeredCount = 0;

            questions.forEach(q => {
                const val = formData.get(`q${q.id}`);
                if (val !== null) {
                    scores[q.category] += parseInt(val, 10);
                    answeredCount++;
                }
            });

            if (answeredCount < questions.length) {
                alert("すべての項目に回答してください。");
                return;
            }

            // 履歴の取得と更新
            const history = getHistory();
            const currentData = {
                date: new Date().toISOString(),
                scores: scores
            };

            // 新しい結果を先頭に追加
            history.unshift(currentData);
            
            // 最大n件まで保持するように変更
            if (history.length > MAX_HISTORY_COUNT) {
                history.pop();
            }

            // 保存
            saveHistory(history);

            // 結果表示
            showResult(history);
        }

        // --- ストレージ操作 ---
        function getHistory() {
            const data = localStorage.getItem(STORAGE_KEY);
            return data ? JSON.parse(data) : [];
        }

        function saveHistory(history) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
        }

        // --- 結果表示 ---
        function showResult(history) {
            const current = history[0].scores;
            // 比較対象は1つ前のデータ（存在する場合）
            const previous = history.length > 1 ? history[1].scores : null;

            // スコア表示更新
            document.getElementById('score-cs').textContent = current.CS;
            document.getElementById('score-bo').textContent = current.BO;
            document.getElementById('score-cf').textContent = current.CF;

            // --- 前回比の表示更新 ---
            updateDiff('cs', current.CS, previous ? previous.CS : null, true);  // CS: 高い方が良い(true)
            updateDiff('bo', current.BO, previous ? previous.BO : null, false); // BO: 低い方が良い(false)
            updateDiff('cf', current.CF, previous ? previous.CF : null, false); // CF: 低い方が良い(false)

            // --- 判定ロジックとステータス表示更新 ---
            // CS: 高いほうが良い
            updateStatus('cs', current.CS, current.CS >= 7, '良好', '要ケア', 'bg-green-100 text-green-700', 'bg-yellow-100 text-yellow-700');
            
            // BO: 低いほうが良い
            updateStatus('bo', current.BO, current.BO <= 6, '良好', '注意', 'bg-green-100 text-green-700', 'bg-orange-100 text-orange-700');

            // CF: 低いほうが良い
            updateStatus('cf', current.CF, current.CF <= 6, '良好', '注意', 'bg-green-100 text-green-700', 'bg-red-100 text-red-700');

            // チャート描画
            drawChart(current, previous);
            
            // 履歴一覧テーブル描画
            renderHistoryTable(history);

            // 表示エリアを開く
            const resultSection = document.getElementById('result-section');
            resultSection.classList.remove('hidden');
            
            // スクロール
            setTimeout(() => {
                resultSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }

        // ステータスバッジの更新ヘルパー関数
        function updateStatus(type, score, isGood, goodText, badText, goodClass, badClass) {
            const el = document.getElementById(`status-${type}`);
            if (isGood) {
                el.textContent = `◎ ${goodText}`;
                el.className = `mt-1 text-sm font-bold px-4 py-1 rounded-full inline-block mx-auto ${goodClass}`;
            } else {
                el.textContent = `⚠ ${badText}`;
                el.className = `mt-1 text-sm font-bold px-4 py-1 rounded-full inline-block mx-auto ${badClass}`;
            }
        }

        // 前回比の更新ヘルパー関数
        function updateDiff(type, currentScore, previousScore, isHigherBetter) {
            const el = document.getElementById(`diff-${type}`);
            
            if (previousScore === null) {
                el.innerHTML = '<span class="text-gray-400 text-xs">前回データなし</span>';
                return;
            }
            
            const diff = currentScore - previousScore;
            
            if (diff === 0) {
                el.innerHTML = '<span class="text-gray-500 text-xs font-medium">前回比: ±0</span>';
                return;
            }
            
            const sign = diff > 0 ? '+' : '';
            // 良くなっているかどうかの判定
            const isImprovement = isHigherBetter ? (diff > 0) : (diff < 0);
            
            const colorClass = isImprovement ? 'text-green-600' : 'text-red-500';
            // 直感的に良し悪しがわかるように矢印の向きを決定
            // CS(高い方が良い)で点数が上がれば ↑(緑)、下がれば ↓(赤)
            // BO(低い方が良い)で点数が下がれば ↓(緑)、上がれば ↑(赤)
            const arrow = diff > 0 ? '↑' : '↓';
            
            el.innerHTML = `<span class="${colorClass} text-sm font-bold">前回比: ${sign}${diff} ${arrow}</span>`;
        }

        // 履歴テーブルの描画関数
        function renderHistoryTable(history) {
            const tbody = document.getElementById('history-tbody');
            tbody.innerHTML = '';
            
            if (!history || history.length === 0) return;

            history.forEach((item, index) => {
                const dateObj = new Date(item.date);
                const dateString = `${dateObj.getFullYear()}/${String(dateObj.getMonth() + 1).padStart(2, '0')}/${String(dateObj.getDate()).padStart(2, '0')}`;
                
                const tr = document.createElement('tr');
                
                // 最新の履歴（今回）は背景色をつけて強調
                if (index === 0) {
                    tr.className = "bg-green-50 font-bold border-b border-gray-200";
                } else {
                    tr.className = "border-b border-gray-100 hover:bg-gray-50 transition-colors";
                }

                tr.innerHTML = `
                    <td class="py-3 px-4">${dateString} ${index === 0 ? '<span class="text-xs text-green-600 ml-1">(今回)</span>' : ''}</td>
                    <td class="py-3 px-4">${item.scores.CS}</td>
                    <td class="py-3 px-4">${item.scores.BO}</td>
                    <td class="py-3 px-4">${item.scores.CF}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Chart.jsによるレーダーチャート描画
        function drawChart(current, previous) {
            const ctx = document.getElementById('resultChart').getContext('2d');

            // 既存のチャートがあれば破棄
            if (radarChart) {
                radarChart.destroy();
            }

            // --- スコアの反転処理 ---
            // CS: そのまま (高い=外側=健康)
            // BO, CF: 12から引く (低い=外側=健康)
            const transformScore = (scores) => {
                if(!scores) return [];
                return [
                    scores.CS,          // CS: そのまま
                    12 - scores.CF,     // CF: 反転
                    12 - scores.BO      // BO: 反転
                ];
            };

            const currentData = transformScore(current);
            const previousData = transformScore(previous);

            const data = {
                labels: [
                    ['共感満足(CS)', '高いほど良い'], 
                    ['共感疲労(CF)', '低いほど良い'], 
                    ['バーンアウト(BO)', '低いほど良い']
                ],
                datasets: [
                    {
                        label: '今回の結果',
                        data: currentData,
                        fill: true,
                        backgroundColor: 'rgba(13, 148, 136, 0.2)', // teal-600 low opacity
                        borderColor: 'rgb(13, 148, 136)',
                        pointBackgroundColor: 'rgb(13, 148, 136)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgb(13, 148, 136)',
                        // ツールチップ用に元のスコアを保持
                        originalScores: [current.CS, current.CF, current.BO]
                    }
                ]
            };

            // 前回データがある場合は追加
            if (previous) {
                data.datasets.push({
                    label: '前回の結果',
                    data: previousData,
                    fill: false,
                    backgroundColor: 'rgba(148, 163, 184, 0.2)', // slate-400
                    borderColor: 'rgb(148, 163, 184)',
                    borderDash: [5, 5], // 点線
                    pointBackgroundColor: 'rgb(148, 163, 184)',
                    pointBorderColor: '#fff',
                    // ツールチップ用に元のスコアを保持
                    originalScores: [previous.CS, previous.CF, previous.BO]
                });
            }

            radarChart = new Chart(ctx, {
                type: 'radar',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: 20 // スマホで見切れないようにパディング追加
                    },
                    elements: {
                        line: {
                            borderWidth: 3
                        }
                    },
                    scales: {
                        r: {
                            angleLines: {
                                display: true,
                                color: 'rgba(100, 116, 139, 0.4)' // 放射状の線を濃く (Slate-500 base)
                            },
                            grid: {
                                color: 'rgba(100, 116, 139, 0.4)' // 同心円状の線を濃く (Slate-500 base)
                            },
                            suggestedMin: 0,
                            suggestedMax: 12, // 仕様上の最大値
                            ticks: {
                                display: false, // 数値は意味が混在するため非表示
                                stepSize: 4
                            },
                            pointLabels: {
                                font: {
                                    size: 11, // フォントサイズを少し小さく
                                    family: "'Noto Sans JP', sans-serif",
                                    weight: 'bold'
                                },
                                color: '#334155'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: {
                                    family: "'Noto Sans JP', sans-serif"
                                },
                                padding: 20
                            }
                        },
                        tooltip: {
                            callbacks: {
                                // ツールチップで実際のスコアを表示する
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const originalScore = context.dataset.originalScores[context.dataIndex];
                                    return `${label}: ${originalScore}点`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // フォームリセット
        function resetForm() {
            if(confirm("入力内容と表示をリセットしますか？\n（保存された履歴は消えません）")) {
                document.getElementById('checkForm').reset();
                document.getElementById('result-section').classList.add('hidden');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }
    </script>
</body>
</html>
